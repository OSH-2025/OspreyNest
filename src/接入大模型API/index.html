<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩËØ≠Èü≥ÊéßÂà∂Á≥ªÁªü</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Â§ßÊ®°ÂûãAPIÈÖçÁΩÆ -->
    <style>
        .api-config {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .api-config h3 {
            margin-top: 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .config-row label {
            min-width: 80px;
            font-weight: bold;
        }
        
        .config-row input, .config-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .config-row input[type="password"] {
            font-family: monospace;
        }
        
        .api-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .api-status.testing {
            background: #fff3cd;
            color: #856404;
        }
        
        .test-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .test-btn:hover {
            background: #5a6fd8;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Â¢ûÂº∫ÁöÑÊ†∑Âºè */
        .voice-control {
            text-align: center;
            margin: 40px 0;
        }
        
        .mic-button {
            display: inline-block;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .mic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .mic-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .mic-button.listening {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            animation: pulse 2s infinite;
        }
        
        .mic-button.wake-listening {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            animation: wakeGlow 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(56, 239, 125, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0);
            }
        }
        
        @keyframes wakeGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }
        
        .mic-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .status-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        
        .status-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .status-item.result {
            border-left-color: #38ef7d;
            background: #f0fff4;
        }
        
        .status-item.error {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .status-item.wake {
            border-left-color: #feca57;
            background: #fffbf0;
        }
        
        .status-item.wasm {
            border-left-color: #9b59b6;
            background: #f8f4ff;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .device-card:hover {
            transform: translateY(-5px);
        }
        
        .device-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .device-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .device-status {
            font-size: 14px;
            color: #666;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .status-on {
            background: #d4edda;
            color: #155724;
        }
        
        .status-off {
            background: #f8d7da;
            color: #721c24;
        }
        
        .debug-panel {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-panel h3 {
            color: #fff;
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .connection-online {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .footer {
            text-align: center;
            padding: 30px 0;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 50px;
        }
        
        .toggle-debug {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .toggle-debug:hover {
            background: #5a6268;
        }

        .wake-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            z-index: 2000;
            display: none;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéôÔ∏è Êô∫ËÉΩËØ≠Èü≥ÊéßÂà∂Á≥ªÁªü</h1>
            <p>ËØ¥"Â∞èÊ¨ßÂ∞èÊ¨ß"Âî§ÈÜíÁ≥ªÁªüÔºåÊîØÊåÅÁÅØÂÖâ„ÄÅÁ©∫Ë∞É„ÄÅÁîµËßÜÁ≠âËÆæÂ§áÊéßÂà∂</p>
        </header>
        
        <!-- Â§ßÊ®°ÂûãAPIÈÖçÁΩÆÂå∫Âüü -->
        <div class="api-config">
            <h3>
                üß† Â§ßÊ®°ÂûãAIÈÖçÁΩÆ
                <span id="api-status" class="api-status disconnected">Êú™ËøûÊé•</span>
            </h3>
            <div class="config-row">
                <label for="api-provider">ÊúçÂä°ÂïÜ:</label>
                <select id="api-provider">
                    <option value="openai">OpenAI (GPT)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="zhipu">Êô∫Ë∞±AI (GLM)</option>
                    <option value="qwen">ÈÄö‰πâÂçÉÈóÆ</option>
                    <option value="moonshot">Moonshot (Kimi)</option>
                    <option value="custom">Ëá™ÂÆö‰πâAPI</option>
                </select>
                <button id="test-api-btn" class="test-btn" onclick="testApiConnection()">ÊµãËØïËøûÊé•</button>
            </div>
            <div class="config-row">
                <label for="api-key">APIÂØÜÈí•:</label>
                <input type="password" id="api-key" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑAPIÂØÜÈí•">
            </div>
            <div class="config-row" id="custom-url-row" style="display: none;">
                <label for="api-url">APIÂú∞ÂùÄ:</label>
                <input type="text" id="api-url" placeholder="https://api.example.com/v1/chat/completions">
            </div>
            <div class="config-row">
                <label for="api-model">Ê®°Âûã:</label>
                <input type="text" id="api-model" placeholder="Ê®°ÂûãÂêçÁß∞ (Â¶Ç: gpt-3.5-turbo)">
            </div>
        </div>
        
        <main>
            <div class="voice-control">
                <button id="start-recognition" class="mic-button">
                    <span class="mic-icon">üé§</span>
                    <span class="mic-text">Ê≠£Âú®ÂàùÂßãÂåñ...</span>
                </button>
            </div>
            
            <div class="status-panel">
                <div class="status-item">
                    <strong>Á≥ªÁªüÁä∂ÊÄÅÔºö</strong>
                    <span id="listening-status">Ê≠£Âú®ÂàùÂßãÂåñÁ≥ªÁªü...</span>
                </div>
                
                <div class="status-item wasm" id="wasm-container" style="display:none;">
                    <strong>üß† WASMÂºïÊìéÔºö</strong>
                    <div id="wasm-status"></div>
                </div>
                
                <div class="status-item wake" id="wake-container" style="display:none;">
                    <strong>üîä Âî§ÈÜíÁä∂ÊÄÅÔºö</strong>
                    <div id="wake-status"></div>
                </div>
                
                <div class="status-item" id="transcription-container" style="display:none;">
                    <strong>üéØ ËØÜÂà´ÁªìÊûúÔºö</strong>
                    <div id="transcription"></div>
                </div>
                
                <div class="status-item result" id="command-container" style="display:none;">
                    <strong>‚ö° Êåá‰ª§Ëß£ÊûêÔºö</strong>
                    <div id="command-result"></div>
                </div>

                <div class="status-item wasm" id="gpio-container" style="display:none;">
                    <strong>üîå GPIOÊéßÂà∂Ôºö</strong>
                    <div id="gpio-command"></div>
                </div>

                <div class="status-item result" id="response-container" style="display:none;">
                    <strong>üó£Ô∏è Á≥ªÁªüÂõûÂ∫îÔºö</strong>
                    <div id="voice-response"></div>
                </div>
            </div>
            
            <div class="device-controls">
                <h2>üè† ËÆæÂ§áÁä∂ÊÄÅ</h2>
                <div class="device-grid">
                    <div class="device-card">
                        <div class="device-icon">üí°</div>
                        <div class="device-name">ÂÆ¢ÂéÖ‰∏ªÁÅØ</div>
                        <div class="device-status">
                            Áä∂ÊÄÅ: <span id="light-status" class="status-indicator status-off">ÂÖ≥Èó≠</span><br>
                            GPIO: <span class="status-indicator status-off">17</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">‚ùÑÔ∏è</div>
                        <div class="device-name">Á©∫Ë∞ÉÁ≥ªÁªü</div>
                        <div class="device-status">
                            Áä∂ÊÄÅ: <span id="ac-status" class="status-indicator status-off">ÂÖ≥Èó≠</span><br>
                            GPIO: <span class="status-indicator status-off">18</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">üì∫</div>
                        <div class="device-name">Êô∫ËÉΩÁîµËßÜ</div>
                        <div class="device-status">
                            Áä∂ÊÄÅ: <span id="tv-status" class="status-indicator status-off">ÂÖ≥Èó≠</span><br>
                            GPIO: <span class="status-indicator status-off">19</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">üå°Ô∏è</div>
                        <div class="device-name">Ê∏©Â∫¶‰º†ÊÑüÂô®</div>
                        <div class="device-status">
                            Ê∏©Â∫¶: <span class="status-indicator status-on">22¬∞C</span><br>
                            GPIO: <span class="status-indicator status-on">Âè™ËØª</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>üí° ‰ΩøÁî®ËØ¥ÊòéÔºöÂÖàËØ¥"Â∞èÊ¨ßÂ∞èÊ¨ß"Âî§ÈÜíÔºåÁÑ∂ÂêéËØ¥ÂêÑÁßçËá™ÁÑ∂ËØ≠Ë®ÄÊåá‰ª§</p>
                <p>üß† <strong>AIÊô∫ËÉΩÊ®°Âºè</strong>ÔºöÊîØÊåÅÂ§öÊ†∑ÂåñË°®ËææÔºåÂ¶Ç"Â∏ÆÊàëÂºÄ‰∏ãÁÅØ"„ÄÅ"Á©∫Ë∞ÉÂèØ‰ª•ÂºÄ‰∏Ä‰∏ãÂêó"„ÄÅ"ÊääÁîµËßÜÂÖ≥Êéâ"Á≠â</p>
                <p>üîß <strong>Âü∫Á°ÄÊ®°Âºè</strong>ÔºöÊîØÊåÅ"ÂºÄÁÅØ"„ÄÅ"ÂÖ≥ÁÅØ"„ÄÅ"ÂºÄÁ©∫Ë∞É"„ÄÅ"ÂÖ≥Á©∫Ë∞É"„ÄÅ"ÂºÄÁîµËßÜ"„ÄÅ"ÂÖ≥ÁîµËßÜ"Á≠âÂõ∫ÂÆöÊåá‰ª§</p>
                <button class="toggle-debug" onclick="toggleDebug()">ÊòæÁ§∫/ÈöêËóèË∞ÉËØï‰ø°ÊÅØ</button>
            </div>
            
            <div class="debug-panel" id="debug-panel" style="display:none;">
                <h3>üîß Á≥ªÁªüË∞ÉËØï‰ø°ÊÅØ</h3>
                <div id="debug-info">Á≥ªÁªüÂêØÂä®‰∏≠...</div>
            </div>
        </main>
    </div>
    
    <!-- ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div id="connection-status" class="connection-status connection-offline">
        ËÆæÂ§áÁ¶ªÁ∫ø
    </div>

    <!-- Âî§ÈÜíÊèêÁ§∫ -->
    <div id="wake-indicator" class="wake-indicator">
        üéØ Â∞èÊ¨ßÂ∑≤Âî§ÈÜíÔºåËØ∑ËØ¥Âá∫Êåá‰ª§
    </div>

    <!-- ÂºïÂÖ•WASMÊ®°Âùó -->
    <script src="nlp-parser.js"></script>

    <script>
        console.log('üöÄ Êô∫ËÉΩËØ≠Èü≥ÊéßÂà∂Á≥ªÁªüÂêØÂä®‰∏≠...');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOMÂä†ËΩΩÂÆåÊàê');
            
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            const startBtn = document.getElementById('start-recognition');
            const status = document.getElementById('listening-status');
            const wasmContainer = document.getElementById('wasm-container');
            const wasmStatus = document.getElementById('wasm-status');
            const wakeContainer = document.getElementById('wake-container');
            const wakeStatus = document.getElementById('wake-status');
            const transcription = document.getElementById('transcription');
            const transcriptionContainer = document.getElementById('transcription-container');
            const commandResult = document.getElementById('command-result');
            const commandContainer = document.getElementById('command-container');
            const gpioContainer = document.getElementById('gpio-container');
            const gpioCommand = document.getElementById('gpio-command');
            const responseContainer = document.getElementById('response-container');
            const voiceResponse = document.getElementById('voice-response');
            const lightStatus = document.getElementById('light-status');
            const acStatus = document.getElementById('ac-status');
            const tvStatus = document.getElementById('tv-status');
            const debugInfo = document.getElementById('debug-info');
            const connectionStatus = document.getElementById('connection-status');
            const wakeIndicator = document.getElementById('wake-indicator');
            
            // ËØ≠Èü≥ÂêàÊàêÂØπË±°
            let speechSynthesis = window.speechSynthesis;
            let currentVoice = null;

            // WASMÊ®°Âùó
            let nlpModule = null;
            let isWasmReady = false;

            // Á≥ªÁªüÁä∂ÊÄÅ
            let isWakeListening = false;  // ÊòØÂê¶Âú®Á≠âÂæÖÂî§ÈÜíËØç
            let isCommandListening = false;  // ÊòØÂê¶Âú®Á≠âÂæÖÊåá‰ª§
            let wakeRecognition = null;
            let commandRecognition = null;
            
            // Â§ßÊ®°ÂûãAPIÈÖçÁΩÆ
            let apiConfig = {
                provider: 'openai',
                apiKey: '',
                apiUrl: '',
                model: 'gpt-3.5-turbo',
                isConnected: false
            };
            
            // Âä†ËΩΩ‰øùÂ≠òÁöÑAPIÈÖçÁΩÆ
            function loadApiConfig() {
                const saved = localStorage.getItem('apiConfig');
                if (saved) {
                    apiConfig = { ...apiConfig, ...JSON.parse(saved) };
                    document.getElementById('api-provider').value = apiConfig.provider;
                    document.getElementById('api-key').value = apiConfig.apiKey;
                    document.getElementById('api-url').value = apiConfig.apiUrl;
                    document.getElementById('api-model').value = apiConfig.model;
                    updateApiProviderUI();
                    if (apiConfig.apiKey) {
                        testApiConnection();
                    }
                }
            }
            
            // ‰øùÂ≠òAPIÈÖçÁΩÆ
            function saveApiConfig() {
                localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
            }
            
            // Êõ¥Êñ∞APIÊúçÂä°ÂïÜUI
            function updateApiProviderUI() {
                const provider = document.getElementById('api-provider').value;
                const customUrlRow = document.getElementById('custom-url-row');
                const modelInput = document.getElementById('api-model');
                
                apiConfig.provider = provider;
                
                if (provider === 'custom') {
                    customUrlRow.style.display = 'flex';
                } else {
                    customUrlRow.style.display = 'none';
                }
                
                // ËÆæÁΩÆÈªòËÆ§Ê®°Âûã
                const defaultModels = {
                    'openai': 'gpt-3.5-turbo',
                    'anthropic': 'claude-3-haiku-20240307',
                    'zhipu': 'glm-4',
                    'qwen': 'qwen-turbo',
                    'moonshot': 'moonshot-v1-8k',
                    'custom': ''
                };
                
                if (defaultModels[provider] && !modelInput.value) {
                    modelInput.value = defaultModels[provider];
                    apiConfig.model = defaultModels[provider];
                }
                
                saveApiConfig();
            }
            
            // Ëé∑ÂèñAPIÁ´ØÁÇπURL
            function getApiUrl(provider) {
                const urls = {
                    'openai': 'https://api.openai.com/v1/chat/completions',
                    'anthropic': 'https://api.anthropic.com/v1/messages',
                    'zhipu': 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                    'qwen': 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                    'moonshot': 'https://api.moonshot.cn/v1/chat/completions',
                    'custom': apiConfig.apiUrl
                };
                return urls[provider] || urls.custom;
            }
            

            
            // Êõ¥Êñ∞APIÈÖçÁΩÆ
            function updateApiConfig() {
                apiConfig.provider = document.getElementById('api-provider').value;
                apiConfig.apiKey = document.getElementById('api-key').value.trim(); // Ëá™Âä®ÂéªÈô§ÂâçÂêéÁ©∫Ê†º
                apiConfig.apiUrl = document.getElementById('api-url').value;
                apiConfig.model = document.getElementById('api-model').value;
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                addDebug(`Êõ¥Êñ∞APIÈÖçÁΩÆ: ÊúçÂä°ÂïÜ=${apiConfig.provider}, Ê®°Âûã=${apiConfig.model}, ÂØÜÈí•ÈïøÂ∫¶=${apiConfig.apiKey.length}`, 'info');
            }
            
            // ÊµãËØïAPIËøûÊé•
            async function testApiConnection() {
                const testBtn = document.getElementById('test-api-btn');
                const apiStatus = document.getElementById('api-status');
                
                // ÂÖàÊõ¥Êñ∞ÈÖçÁΩÆ
                updateApiConfig();
                
                if (!apiConfig.apiKey.trim()) {
                    alert('ËØ∑ÂÖàÂ°´ÂÖ•APIÂØÜÈí•');
                    return;
                }
                
                // Êô∫Ë∞±AIÂØÜÈí•Ê†ºÂºèÊ£ÄÊü•
                if (apiConfig.provider === 'zhipu') {
                    const trimmedKey = apiConfig.apiKey.trim();
                    if (trimmedKey.length < 20) {
                        alert('Êô∫Ë∞±AIÂØÜÈí•Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂØÜÈí•ÈïøÂ∫¶ËøáÁü≠');
                        return;
                    }
                }
                
                testBtn.disabled = true;
                testBtn.textContent = 'ÊµãËØï‰∏≠...';
                apiStatus.className = 'api-status testing';
                apiStatus.textContent = 'ÊµãËØï‰∏≠';
                
                try {
                    const result = await callLLMAPI('‰Ω†Â•Ω');
                    if (result && result.trim().length > 0) {
                        apiConfig.isConnected = true;
                        apiStatus.className = 'api-status connected';
                        apiStatus.textContent = 'Â∑≤ËøûÊé•';
                        addDebug(`Â§ßÊ®°ÂûãAPIËøûÊé•ÊµãËØïÊàêÂäüÔºåÂìçÂ∫î: ${result}`, 'success');
                        alert('APIËøûÊé•ÊàêÂäüÔºÅ');
                    } else {
                        throw new Error('APIÂìçÂ∫î‰∏∫Á©∫');
                    }
                } catch (error) {
                    apiConfig.isConnected = false;
                    apiStatus.className = 'api-status disconnected';
                    apiStatus.textContent = 'ËøûÊé•Â§±Ë¥•';
                    addDebug(`APIËøûÊé•ÊµãËØïÂ§±Ë¥•: ${error.message}`, 'error');
                    alert(`APIËøûÊé•Â§±Ë¥•: ${error.message}\n\nÊ£ÄÊü•Ë¶ÅÁÇπÔºö\n1. APIÂØÜÈí•Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. ÊòØÂê¶ÊúâË∂≥Â§üÁöÑAPI‰ΩôÈ¢ù`);
                }
                
                testBtn.disabled = false;
                testBtn.textContent = 'ÊµãËØïËøûÊé•';
                saveApiConfig();
            }
            
            // Ë∞ÉÁî®Â§ßÊ®°ÂûãAPI
            async function callLLMAPI(userMessage) {
                if (!apiConfig.apiKey) {
                    throw new Error('APIÂØÜÈí•Êú™ÈÖçÁΩÆ');
                }
                
                const url = getApiUrl(apiConfig.provider);
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // ‰∏çÂêåÊúçÂä°ÂïÜÁöÑËÆ§ËØÅÊñπÂºè
                if (apiConfig.provider === 'openai' || apiConfig.provider === 'moonshot') {
                    headers['Authorization'] = `Bearer ${apiConfig.apiKey}`;
                } else if (apiConfig.provider === 'anthropic') {
                    headers['x-api-key'] = apiConfig.apiKey;
                    headers['anthropic-version'] = '2023-06-01';
                } else if (apiConfig.provider === 'zhipu') {
                    // Êô∫Ë∞±AI‰ΩøÁî®BearerËÆ§ËØÅÔºåÊîØÊåÅÊñ∞ÁâàAPI KeyÊ†ºÂºè
                    headers['Authorization'] = `Bearer ${apiConfig.apiKey}`;
                } else if (apiConfig.provider === 'qwen') {
                    headers['Authorization'] = `Bearer ${apiConfig.apiKey}`;
                } else if (apiConfig.provider === 'custom') {
                    headers['Authorization'] = `Bearer ${apiConfig.apiKey}`;
                }
                
                // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
                let requestBody;
                
                if (apiConfig.provider === 'anthropic') {
                    requestBody = {
                        model: apiConfig.model,
                        max_tokens: 200,
                        messages: [
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ]
                    };
                } else if (apiConfig.provider === 'qwen') {
                    requestBody = {
                        model: apiConfig.model,
                        input: {
                            messages: [
                                {
                                    role: 'user',
                                    content: userMessage
                                }
                            ]
                        },
                        parameters: {
                            max_tokens: 200
                        }
                    };
                } else {
                    // OpenAIÂÖºÂÆπÊ†ºÂºè (OpenAI, Êô∫Ë∞±, Moonshot, Ëá™ÂÆö‰πâ)
                    requestBody = {
                        model: apiConfig.model,
                        messages: [
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        max_tokens: 200,
                        temperature: 0.7
                    };
                }
                
                // ËÆ∞ÂΩïËØ∑Ê±ÇËØ¶ÊÉÖ
                addDebug(`ÂèëÈÄÅAPIËØ∑Ê±ÇÂà∞: ${url}`, 'info');
                addDebug(`ËØ∑Ê±ÇÂ§¥: ${JSON.stringify(headers, null, 2)}`, 'info');
                addDebug(`ËØ∑Ê±Ç‰Ωì: ${JSON.stringify(requestBody, null, 2)}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                addDebug(`ÂìçÂ∫îÁä∂ÊÄÅ: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addDebug(`ÈîôËØØÂìçÂ∫îÂÜÖÂÆπ: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nËØ¶ÁªÜÈîôËØØ: ${errorText}`);
                }
                
                const data = await response.json();
                
                // Ëß£Êûê‰∏çÂêåÊúçÂä°ÂïÜÁöÑÂìçÂ∫îÊ†ºÂºè
                let content = '';
                if (apiConfig.provider === 'anthropic') {
                    content = data.content[0].text;
                } else if (apiConfig.provider === 'qwen') {
                    content = data.output.choices[0].message.content;
                } else {
                    // OpenAIÂÖºÂÆπÊ†ºÂºè
                    content = data.choices[0].message.content;
                }
                
                return content;
            }
            
            // ÂàùÂßãÂåñWASMÊ®°Âùó
            async function initWasmModule() {
                try {
                    addDebug('ÂºÄÂßãÂä†ËΩΩWASMÊ®°Âùó...', 'info');
                    wasmContainer.style.display = 'block';
                    wasmStatus.textContent = 'Ê≠£Âú®Âä†ËΩΩWASMÊ®°Âùó...';
                    
                    // Âä†ËΩΩWASMÊ®°Âùó
                    nlpModule = await createNlpParserModule();
                    isWasmReady = true;
                    
                    addDebug('WASMÊ®°ÂùóÂä†ËΩΩÊàêÂäü', 'success');
                    wasmStatus.textContent = '‚úÖ WASM NLPÂºïÊìéÂ∑≤Â∞±Áª™';
                    
                    return true;
                } catch (error) {
                    addDebug(`WASMÊ®°ÂùóÂä†ËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
                    wasmStatus.textContent = `‚ùå WASMÂä†ËΩΩÂ§±Ë¥•: ${error.message}`;
                    isWasmReady = false;
                    return false;
                }
            }
            
            // ÂàùÂßãÂåñËØ≠Èü≥ÂêàÊàê
            function initSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    // Á≠âÂæÖËØ≠Èü≥ÂàóË°®Âä†ËΩΩ
                    speechSynthesis.onvoiceschanged = function() {
                        const voices = speechSynthesis.getVoices();
                        // ‰ºòÂÖàÈÄâÊã©‰∏≠ÊñáËØ≠Èü≥
                        currentVoice = voices.find(voice => 
                            voice.lang.includes('zh') || voice.lang.includes('cmn')
                        ) || voices[0];
                        
                        if (currentVoice) {
                            addDebug(`ËØ≠Èü≥ÂêàÊàêÂàùÂßãÂåñÊàêÂäüÔºå‰ΩøÁî®ËØ≠Èü≥: ${currentVoice.name}`, 'success');
                        }
                    };
                    
                    // Ëß¶ÂèëËØ≠Èü≥ÂàóË°®Âä†ËΩΩ
                    speechSynthesis.getVoices();
                    addDebug('ËØ≠Èü≥ÂêàÊàêÂäüËÉΩÂèØÁî®', 'success');
                    return true;
                } else {
                    addDebug('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàê', 'warning');
                    return false;
                }
            }

            // ËØ≠Èü≥ÂõûÂ∫îÂáΩÊï∞
            function speak(text) {
                if (!speechSynthesis || !currentVoice) {
                    addDebug('ËØ≠Èü≥ÂêàÊàê‰∏çÂèØÁî®', 'warning');
                    return;
                }

                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = currentVoice;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                utterance.onstart = function() {
                    addDebug(`ÂºÄÂßãËØ≠Èü≥ÂõûÂ∫î: "${text}"`, 'voice');
                    voiceResponse.textContent = text;
                    responseContainer.style.display = 'block';
                };

                utterance.onend = function() {
                    addDebug('ËØ≠Èü≥ÂõûÂ∫îÂÆåÊàê', 'voice');
                };

                utterance.onerror = function(event) {
                    addDebug(`ËØ≠Èü≥ÂõûÂ∫îÈîôËØØ: ${event.error}`, 'error');
                };

                speechSynthesis.speak(utterance);
            }
            
            // Ë∞ÉËØï‰ø°ÊÅØÂáΩÊï∞
            function addDebug(message, type = 'info') {
                console.log(message);
                const now = new Date().toLocaleTimeString();
                const icons = {
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    voice: 'üé§',
                    wake: 'üîä',
                    wasm: 'üß†'
                };
                const icon = icons[type] || '‚ÑπÔ∏è';
                debugInfo.innerHTML = `<div>[${now}] ${icon} ${message}</div>` + debugInfo.innerHTML;
                
                // ÈôêÂà∂Ë∞ÉËØï‰ø°ÊÅØÊù°Êï∞
                const lines = debugInfo.getElementsByTagName('div');
                if (lines.length > 50) {
                    debugInfo.removeChild(lines[lines.length - 1]);
                }
            }
            
            // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
            function updateConnectionStatus(connected) {
                if (connected) {
                    connectionStatus.textContent = 'ËÆæÂ§áÂú®Á∫ø';
                    connectionStatus.className = 'connection-status connection-online';
                } else {
                    connectionStatus.textContent = 'ËÆæÂ§áÁ¶ªÁ∫ø';
                    connectionStatus.className = 'connection-status connection-offline';
                }
            }
            
            // Ê£ÄÊü•ËØ≠Èü≥ËØÜÂà´ÊîØÊåÅ
            addDebug('Ê£ÄÊü•ÊµèËßàÂô®ËØ≠Èü≥ËØÜÂà´ÊîØÊåÅ...', 'info');
            const hasWebkitSpeech = 'webkitSpeechRecognition' in window;
            const hasSpeech = 'SpeechRecognition' in window;
            
            addDebug(`webkitSpeechRecognition: ${hasWebkitSpeech}`, 'info');
            addDebug(`SpeechRecognition: ${hasSpeech}`, 'info');
            
            if (!hasWebkitSpeech && !hasSpeech) {
                status.textContent = '‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÔºåËØ∑‰ΩøÁî®ChromeÊàñEdgeÊµèËßàÂô®';
                startBtn.disabled = true;
                addDebug('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´API', 'error');
                alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩÔºÅ\n\nËØ∑‰ΩøÁî®‰ª•‰∏ãÊµèËßàÂô®Ôºö\n‚Ä¢ Google Chrome\n‚Ä¢ Microsoft Edge\n‚Ä¢ ÂÖ∂‰ªñÂü∫‰∫éChromiumÁöÑÊµèËßàÂô®');
                return;
            }

            // ÂàùÂßãÂåñËØ≠Èü≥ÂêàÊàê
            const hasSpeechSynthesis = initSpeechSynthesis();
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            // ÂàõÂª∫Âî§ÈÜíËØçËØÜÂà´Âô®
            try {
                wakeRecognition = new SpeechRecognition();
                wakeRecognition.continuous = true;  // ÊåÅÁª≠ÁõëÂê¨
                wakeRecognition.interimResults = true;
                wakeRecognition.lang = 'zh-CN';
                wakeRecognition.maxAlternatives = 1;
                
                // ÂàõÂª∫Êåá‰ª§ËØÜÂà´Âô®
                commandRecognition = new SpeechRecognition();
                commandRecognition.continuous = false;
                commandRecognition.interimResults = true;
                commandRecognition.lang = 'zh-CN';
                commandRecognition.maxAlternatives = 1;
                
                addDebug('ËØ≠Èü≥ËØÜÂà´ÂºïÊìéÂàùÂßãÂåñÊàêÂäü', 'success');
            } catch (error) {
                addDebug(`ËØ≠Èü≥ËØÜÂà´ÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`, 'error');
                status.textContent = '‚ùå ËØ≠Èü≥ËØÜÂà´ÂàùÂßãÂåñÂ§±Ë¥•';
                startBtn.disabled = true;
                return;
            }
            
            // ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            startBtn.addEventListener('click', function() {
                if (isWakeListening) {
                    // ÂÅúÊ≠¢Âî§ÈÜíÁõëÂê¨
                    stopWakeListening();
                } else if (isCommandListening) {
                    // ÂÅúÊ≠¢Êåá‰ª§ÁõëÂê¨
                    stopCommandListening();
                } else {
                    // ÂºÄÂßãÂî§ÈÜíÁõëÂê¨
                    startWakeListening();
                }
            });

            // ÂºÄÂßãÂî§ÈÜíÁõëÂê¨
            function startWakeListening() {
                if (!isWasmReady) {
                    addDebug('WASMÊ®°ÂùóÊú™Â∞±Áª™ÔºåÊó†Ê≥ïÂêØÂä®Âî§ÈÜíÁõëÂê¨', 'error');
                    status.textContent = '‚ùå Á≠âÂæÖWASMÊ®°ÂùóÂä†ËΩΩ...';
                    return;
                }

                try {
                    addDebug('ÂºÄÂßãÁõëÂê¨Âî§ÈÜíËØç "Â∞èÊ¨ßÂ∞èÊ¨ß"', 'wake');
                    isWakeListening = true;
                    
                    startBtn.classList.add('wake-listening');
                    startBtn.querySelector('.mic-text').textContent = 'Ê≠£Âú®ÁõëÂê¨Âî§ÈÜíËØç... (ÁÇπÂáªÂÅúÊ≠¢)';
                    status.textContent = 'üîä Ê≠£Âú®ÁõëÂê¨ "Â∞èÊ¨ßÂ∞èÊ¨ß"ÔºåËØ∑Ê∏ÖÊô∞ËØ¥Âá∫Âî§ÈÜíËØç...';
                    
                    wakeContainer.style.display = 'block';
                    wakeStatus.textContent = 'Á≠âÂæÖÂî§ÈÜíËØç "Â∞èÊ¨ßÂ∞èÊ¨ß"...';
                    
                    wakeRecognition.start();
                } catch (error) {
                    addDebug(`ÂêØÂä®Âî§ÈÜíÁõëÂê¨Â§±Ë¥•: ${error.message}`, 'error');
                    status.textContent = '‚ùå ÂêØÂä®Â§±Ë¥•: ' + error.message;
                    isWakeListening = false;
                }
            }

            // ÂÅúÊ≠¢Âî§ÈÜíÁõëÂê¨
            function stopWakeListening() {
                addDebug('ÂÅúÊ≠¢Âî§ÈÜíÁõëÂê¨', 'wake');
                isWakeListening = false;
                wakeRecognition.stop();
                
                startBtn.classList.remove('wake-listening');
                startBtn.querySelector('.mic-text').textContent = 'ÂºÄÂßãËØ≠Èü≥Âî§ÈÜí';
                status.textContent = '‚è∏Ô∏è Â∑≤ÂÅúÊ≠¢ÁõëÂê¨ÔºåÁÇπÂáªÊåâÈíÆÈáçÊñ∞ÂºÄÂßã';
                wakeContainer.style.display = 'none';
            }

            // ÂºÄÂßãÊåá‰ª§ÁõëÂê¨
            function startCommandListening() {
                try {
                    addDebug('ÂºÄÂßãÁõëÂê¨ËØ≠Èü≥Êåá‰ª§', 'voice');
                    isCommandListening = true;
                    
                    startBtn.classList.add('listening');
                    startBtn.querySelector('.mic-text').textContent = 'Ê≠£Âú®ÁõëÂê¨Êåá‰ª§... (ÁÇπÂáªÂÅúÊ≠¢)';
                    status.textContent = 'üéôÔ∏è ËØ∑ËØ¥Âá∫ÊÇ®ÁöÑÊåá‰ª§...';

                    // ÊòæÁ§∫Âî§ÈÜíÊèêÁ§∫
                    wakeIndicator.style.display = 'block';
                    setTimeout(() => {
                        wakeIndicator.style.display = 'none';
                    }, 2000);
                    
                    commandRecognition.start();
                } catch (error) {
                    addDebug(`ÂêØÂä®Êåá‰ª§ÁõëÂê¨Â§±Ë¥•: ${error.message}`, 'error');
                    isCommandListening = false;
                }
            }

            // ÂÅúÊ≠¢Êåá‰ª§ÁõëÂê¨
            function stopCommandListening() {
                addDebug('ÂÅúÊ≠¢Êåá‰ª§ÁõëÂê¨', 'voice');
                isCommandListening = false;
                commandRecognition.stop();
                
                startBtn.classList.remove('listening');
                
                // ÂõûÂà∞Âî§ÈÜíÁõëÂê¨Ê®°Âºè
                setTimeout(() => {
                    if (!isWakeListening && !isCommandListening) {
                        startWakeListening();
                    }
                }, 1000);
            }
            
            // Âî§ÈÜíËØçËØÜÂà´‰∫ã‰ª∂
            wakeRecognition.onresult = function(event) {
                let transcript = '';
                
                // Ëé∑ÂèñÊúÄÊñ∞ÁöÑËØÜÂà´ÁªìÊûú
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                
                if (transcript) {
                    const cleanText = transcript.replace(/[„ÄÇÔºÅÔºüÔºå„ÄÅÔºõÔºö""''ÔºàÔºâ„Äê„Äë\s]/g, '').toLowerCase();
                    addDebug(`Âî§ÈÜíÁõëÂê¨ÁªìÊûú: "${transcript}" -> "${cleanText}"`, 'wake');
                    
                    wakeStatus.textContent = `ÁõëÂê¨Âà∞: "${transcript}"`;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âî§ÈÜíËØç
                    if (cleanText.includes('Â∞èÊ¨ßÂ∞èÊ¨ß') || cleanText.includes('Â∞èÊ¨ß') || 
                        cleanText.includes('xiaoou') || cleanText.includes('Â∞èo')) {
                        
                        addDebug('Ê£ÄÊµãÂà∞Âî§ÈÜíËØçÔºÅÂàáÊç¢Âà∞Êåá‰ª§Ê®°Âºè', 'wake');
                        wakeStatus.textContent = '‚úÖ Âî§ÈÜíÊàêÂäüÔºÅÊ≠£Âú®ÂàáÊç¢Âà∞Êåá‰ª§Ê®°Âºè...';
                        
                        // ËØ≠Èü≥ÂõûÂ∫î
                        if (hasSpeechSynthesis) {
                            speak('ÊàëÂú®ÔºåËØ∑ËØ¥Âá∫ÊÇ®ÁöÑÊåá‰ª§');
                        }
                        
                        // ÂÅúÊ≠¢Âî§ÈÜíÁõëÂê¨ÔºåÂºÄÂßãÊåá‰ª§ÁõëÂê¨
                        stopWakeListening();
                        setTimeout(() => {
                            startCommandListening();
                        }, 500);
                    }
                }
            };

            wakeRecognition.onerror = function(event) {
                addDebug(`Âî§ÈÜíÁõëÂê¨ÈîôËØØ: ${event.error}`, 'error');
                if (event.error !== 'no-speech') {
                    wakeStatus.textContent = `ÈîôËØØ: ${event.error}`;
                }
            };

            wakeRecognition.onend = function() {
                if (isWakeListening) {
                    // Â¶ÇÊûúËøòÂú®Âî§ÈÜíÊ®°ÂºèÔºåÈáçÊñ∞ÂêØÂä®ÁõëÂê¨
                    setTimeout(() => {
                        if (isWakeListening) {
                            try {
                                wakeRecognition.start();
                            } catch (error) {
                                addDebug(`ÈáçÂêØÂî§ÈÜíÁõëÂê¨Â§±Ë¥•: ${error.message}`, 'error');
                            }
                        }
                    }, 100);
                }
            };
            
            // Êåá‰ª§ËØÜÂà´‰∫ã‰ª∂
            commandRecognition.onresult = function(event) {
                addDebug(`Êî∂Âà∞Êåá‰ª§ËØÜÂà´ÁªìÊûúÔºåÂÖ±${event.results.length}Êù°`, 'voice');
                
                let transcript = '';
                let isFinal = false;
                
                // Ëé∑ÂèñËØÜÂà´ÁªìÊûú
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        transcript = result[0].transcript.trim();
                        isFinal = true;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊúÄÁªàÁªìÊûúÔºåËé∑Âèñ‰∏¥Êó∂ÁªìÊûú
                if (!transcript && event.results.length > 0) {
                    transcript = event.results[event.results.length - 1][0].transcript.trim();
                }
                
                if (transcript) {
                    addDebug(`ËØÜÂà´ÊñáÊú¨: "${transcript}" (${isFinal ? 'ÊúÄÁªàÁªìÊûú' : '‰∏¥Êó∂ÁªìÊûú'})`, 'voice');
                    
                    // ÊòæÁ§∫ËØÜÂà´ÁªìÊûú
                    transcription.textContent = `"${transcript}"${isFinal ? '' : ' (ËØÜÂà´‰∏≠...)'}`;
                    transcriptionContainer.style.display = 'block';
                    
                    // Âè™Â§ÑÁêÜÊúÄÁªàÁªìÊûú
                    if (isFinal) {
                        parseCommandWithWasm(transcript);

                        // Êåá‰ª§Â§ÑÁêÜÂÆåÊàêÔºåÂÅúÊ≠¢ÁõëÂê¨
                        setTimeout(() => {
                            stopCommandListening();
                        }, 1000);
                    }
                }
            };
            
            commandRecognition.onerror = function(event) {
                addDebug(`Êåá‰ª§ËØÜÂà´ÈîôËØØ: ${event.error}`, 'error');
                
                let errorMessage = 'Êåá‰ª§ËØÜÂà´Â§±Ë¥•';
                switch (event.error) {
                    case 'not-allowed':
                        errorMessage = '‚ùå È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ';
                        alert('ËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éÊùÉÈôêÔºÅ\n\nÂú®ÊµèËßàÂô®Âú∞ÂùÄÊ†èÂ∑¶‰æßÁÇπÂáªüîíÂõæÊ†áÔºåÁÑ∂ÂêéÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ„ÄÇ');
                        break;
                    case 'no-speech':
                        errorMessage = '‚ö†Ô∏è Ê≤°ÊúâÊ£ÄÊµãÂà∞ËØ≠Èü≥ÔºåËØ∑ÈáçËØï';
                        if (hasSpeechSynthesis) {
                            speak('Ê≤°ÊúâÂê¨Âà∞ÊÇ®ÁöÑÊåá‰ª§ÔºåËØ∑ÈáçÊñ∞ËØ¥Âá∫');
                        }
                        break;
                    case 'audio-capture':
                        errorMessage = '‚ùå È∫¶ÂÖãÈ£éËÆæÂ§áÊó†Ê≥ï‰ΩøÁî®';
                        break;
                    case 'network':
                        errorMessage = '‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥•';
                        break;
                }
                
                status.textContent = errorMessage;
            };
            
            commandRecognition.onend = function() {
                addDebug('Êåá‰ª§ËØÜÂà´‰ºöËØùÁªìÊùü', 'info');
                isCommandListening = false;
                startBtn.classList.remove('listening');
                startBtn.querySelector('.mic-text').textContent = 'ÂºÄÂßãËØ≠Èü≥Âî§ÈÜí';
                status.textContent = '‚è∏Ô∏è Êåá‰ª§ËØÜÂà´ÂÆåÊàê';
            };
            
            // Êô∫ËÉΩÊåá‰ª§Ëß£Êûê - ‰ºòÂÖàÁ∫ßÔºöÂ§ßÊ®°ÂûãAPI > WASM > Â§áÁî®Ëß£Êûê
            function parseCommandWithWasm(text) {
                // ‰ºòÂÖà‰ΩøÁî®Â§ßÊ®°ÂûãAPI
                if (apiConfig.isConnected) {
                    parseCommandWithLLM(text);
                    return;
                }
                
                // ÂÖ∂Ê¨°‰ΩøÁî®WASMÊ®°Âùó
                if (!isWasmReady || !nlpModule) {
                    addDebug('WASMÊ®°Âùó‰∏çÂèØÁî®Ôºå‰ΩøÁî®Â§áÁî®Ëß£Êûê', 'warning');
                    parseCommandFallback(text);
                    return;
                }

                try {
                    // Ê∏ÖÁêÜËæìÂÖ•ÊñáÊú¨ÔºåÁßªÈô§Ê†áÁÇπÁ¨¶Âè∑ÂíåÂ§ö‰ΩôÁ©∫Ê†º
                    const cleanText = text.replace(/[„ÄÇÔºÅÔºüÔºå„ÄÅÔºõÔºö""''ÔºàÔºâ„Äê„Äë]/g, '').trim();
                    addDebug(`‰ΩøÁî®WASMËß£ÊûêÊåá‰ª§: ÂéüÊñá="${text}" Ê∏ÖÁêÜÂêé="${cleanText}"`, 'wasm');
                    
                    // Ê£ÄÊü•WASMÊ®°ÂùóÂáΩÊï∞ÊòØÂê¶Â≠òÂú®
                    if (!nlpModule._parseCommandAndReturnJSON) {
                        throw new Error('WASMÂáΩÊï∞_parseCommandAndReturnJSON‰∏çÂ≠òÂú®');
                    }
                    
                    // Ë∞ÉÁî®WASMÂáΩÊï∞Ëß£ÊûêÊåá‰ª§Ôºà‰ΩøÁî®Ê∏ÖÁêÜÂêéÁöÑÊñáÊú¨Ôºâ
                    const jsonPtr = nlpModule.ccall('parseCommandAndReturnJSON', 'number', ['string'], [cleanText]);
                    
                    if (!jsonPtr || jsonPtr === 0) {
                        throw new Error('WASMÂáΩÊï∞ËøîÂõûÁ©∫ÊåáÈíàÊàñ0');
                    }
                    
                    // Ëé∑ÂèñJSONÂ≠óÁ¨¶‰∏≤
                    const jsonString = nlpModule.UTF8ToString(jsonPtr);
                    addDebug(`WASMËß£ÊûêÁªìÊûú: ${jsonString}`, 'wasm');
                    
                    // ÈáäÊîæÂÜÖÂ≠ò
                    if (nlpModule._freeJSONResult) {
                        nlpModule._freeJSONResult(jsonPtr);
                    } else {
                        addDebug('Ë≠¶ÂëäÔºöfreeJSONResultÂáΩÊï∞‰∏çÂ≠òÂú®ÔºåÂèØËÉΩÊúâÂÜÖÂ≠òÊ≥ÑÊºè', 'warning');
                    }
                    
                    // Ëß£ÊûêJSONÁªìÊûú
                    const command = JSON.parse(jsonString);
                    
                    // Ê£ÄÊü•Ëß£ÊûêÁªìÊûúÁöÑÊúâÊïàÊÄß
                    addDebug(`Ëß£ÊûêÂà∞ÁöÑÊåá‰ª§ÂØπË±°: ${JSON.stringify(command)}`, 'wasm');
                    
                    if (command && command.action && command.target && 
                        command.action.trim() !== '' && command.target.trim() !== '') {
                        addDebug(`Êåá‰ª§Ëß£ÊûêÊàêÂäü: ${JSON.stringify(command)}`, 'success');
                        commandResult.textContent = `${command.action} ${command.target}`;
                        commandContainer.style.display = 'block';
                        commandContainer.className = 'status-item result';
                        
                        // ÊòæÁ§∫GPIOÊéßÂà∂ÂëΩ‰ª§
                        if (command.gpioCommand && command.gpioCommand.trim() !== '') {
                            gpioCommand.textContent = command.gpioCommand;
                            gpioContainer.style.display = 'block';
                            addDebug(`GPIOÊéßÂà∂ÂëΩ‰ª§: ${command.gpioCommand}`, 'wasm');
                        }
                        
                        // ÊâßË°åËÆæÂ§áÊéßÂà∂
                        executeCommand(command);
                    } else {
                        addDebug(`WASMËøîÂõû‰∫ÜÊó†ÊïàÁöÑÊåá‰ª§ÂØπË±°: ${JSON.stringify(command)}`, 'warning');
                        // Â¶ÇÊûúWASMËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®Ëß£Êûê
                        addDebug('WASMËß£ÊûêÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞Â§áÁî®Ëß£ÊûêÂô®', 'warning');
                        parseCommandFallback(text);
                    }
                } catch (error) {
                    addDebug(`WASMËß£ÊûêÂ§±Ë¥•: ${error.message}`, 'error');
                    addDebug(`ÈîôËØØÂ†ÜÊ†à: ${error.stack}`, 'error');
                    // Â¶ÇÊûúWASMËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®Ëß£ÊûêÂô®
                    addDebug('Áî±‰∫éWASMÈîôËØØÔºåÂàáÊç¢Âà∞Â§áÁî®Ëß£ÊûêÂô®', 'warning');
                    parseCommandFallback(text);
                }
            }
            
            // ‰ΩøÁî®Â§ßÊ®°ÂûãAPIËß£ÊûêËØ≠Èü≥Êåá‰ª§
            async function parseCommandWithLLM(text) {
                try {
                    addDebug(`‰ΩøÁî®Â§ßÊ®°ÂûãAPIËß£ÊûêÊåá‰ª§: "${text}"`, 'info');
                    
                    // ÊûÑÂª∫Êõ¥ËØ¶ÁªÜÁöÑÊèêÁ§∫ËØç
                    const prompt = `Áî®Êà∑ËØ¥Ôºö"${text}"

ËØ∑ÂàÜÊûêËøôÂè•ËØùÊòØÂê¶ÊòØÊô∫ËÉΩÂÆ∂Â±ÖÊéßÂà∂Êåá‰ª§„ÄÇ

ÊîØÊåÅÁöÑËÆæÂ§áÔºö
- ÁÅØÔºàÂÆ¢ÂéÖ‰∏ªÁÅØÔºâ- GPIO 17
- Á©∫Ë∞ÉÔºàÁ©∫Ë∞ÉÁ≥ªÁªüÔºâ- GPIO 18  
- ÁîµËßÜÔºàÊô∫ËÉΩÁîµËßÜÔºâ- GPIO 19

ÊîØÊåÅÁöÑÊìç‰ΩúÔºö
- ÊâìÂºÄ/ÂºÄÂêØ/ÂêØÂä®/ÂºÄ
- ÂÖ≥Èó≠/ÂÖ≥/ÂÅúÊ≠¢/ÂÖ≥Êéâ

ËØ∑ËøîÂõûJSONÊ†ºÂºèÁªìÊûúÔºö
{
  "action": "ÊâìÂºÄ|ÂÖ≥Èó≠", 
  "target": "ÁÅØ|Á©∫Ë∞É|ÁîµËßÜ",
  "gpioCommand": "gpio [17|18|19] [high|low]",
  "confidence": 0.95,
  "response": "Â•ΩÁöÑÔºåÁÅØÂ∑≤ÊâìÂºÄ"
}

Â¶ÇÊûú‰∏çÊòØËÆæÂ§áÊéßÂà∂Êåá‰ª§ÔºåËøîÂõûÔºö
{
  "action": "",
  "target": "", 
  "gpioCommand": "",
  "confidence": 0.0,
  "response": "Êä±Ê≠âÔºåÊàë‰∏çÁêÜËß£Ëøô‰∏™Êåá‰ª§„ÄÇËØ∑ËØ¥ÂºÄÁÅØ„ÄÅÂÖ≥ÁÅØ„ÄÅÂºÄÁ©∫Ë∞É„ÄÅÂÖ≥Á©∫Ë∞É„ÄÅÂºÄÁîµËßÜ„ÄÅÂÖ≥ÁîµËßÜÁ≠âÊåá‰ª§„ÄÇ"
}

Âè™ËøîÂõûJSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ`;

                    const apiResponse = await callLLMAPI(prompt);
                    addDebug(`Â§ßÊ®°ÂûãAPIÂéüÂßãÂìçÂ∫î: ${apiResponse}`, 'info');
                    
                    // Â∞ùËØïËß£ÊûêJSONÂìçÂ∫î
                    let command;
                    try {
                        // ÊèêÂèñJSONÈÉ®ÂàÜÔºàÂéªÈô§ÂèØËÉΩÁöÑmarkdownÊ†ºÂºèÔºâ
                        const jsonMatch = apiResponse.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            command = JSON.parse(jsonMatch[0]);
                        } else {
                            command = JSON.parse(apiResponse);
                        }
                    } catch (jsonError) {
                        addDebug(`JSONËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÊô∫ËÉΩÊèêÂèñ: ${jsonError.message}`, 'warning');
                        // Êô∫ËÉΩÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ
                        command = extractCommandFromText(apiResponse, text);
                    }
                    
                    addDebug(`Â§ßÊ®°ÂûãËß£ÊûêÁªìÊûú: ${JSON.stringify(command)}`, 'success');
                    
                    // Ê£ÄÊü•Ëß£ÊûêÁªìÊûúÁöÑÊúâÊïàÊÄß
                    if (command && command.action && command.target && 
                        command.action.trim() !== '' && command.target.trim() !== '') {
                        
                        commandResult.textContent = `${command.action} ${command.target}`;
                        commandContainer.style.display = 'block';
                        commandContainer.className = 'status-item result';
                        
                        // ÊòæÁ§∫GPIOÊéßÂà∂ÂëΩ‰ª§
                        if (command.gpioCommand && command.gpioCommand.trim() !== '') {
                            gpioCommand.textContent = command.gpioCommand;
                            gpioContainer.style.display = 'block';
                            addDebug(`GPIOÊéßÂà∂ÂëΩ‰ª§: ${command.gpioCommand}`, 'success');
                        }
                        
                        // ÊâßË°åËÆæÂ§áÊéßÂà∂
                        executeCommand(command);
                        
                        // ‰ΩøÁî®AIÁîüÊàêÁöÑÂõûÂ∫î
                        if (command.response && hasSpeechSynthesis) {
                            speak(command.response);
                        }
                    } else {
                        // ÊòæÁ§∫AIÁöÑËß£Èáä
                        const errorMsg = command.response || `Êó†Ê≥ïÁêÜËß£Êåá‰ª§ "${text}"`;
                        commandResult.textContent = errorMsg;
                        commandContainer.style.display = 'block';
                        commandContainer.className = 'status-item error';
                        
                        if (hasSpeechSynthesis) {
                            speak(errorMsg);
                        }
                    }
                    
                } catch (error) {
                    addDebug(`Â§ßÊ®°ÂûãAPIËß£ÊûêÂ§±Ë¥•: ${error.message}`, 'error');
                    // ÈôçÁ∫ßÂà∞WASMÊàñÂ§áÁî®Ëß£Êûê
                    if (isWasmReady && nlpModule) {
                        addDebug('Â§ßÊ®°ÂûãAPIÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞WASMËß£Êûê', 'warning');
                        parseCommandWithWasmOnly(text);
                    } else {
                        addDebug('Â§ßÊ®°ÂûãAPIÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞Â§áÁî®Ëß£Êûê', 'warning');
                        parseCommandFallback(text);
                    }
                }
            }
            
            // Êô∫ËÉΩÊèêÂèñÊåá‰ª§‰ø°ÊÅØÔºàÂΩìJSONËß£ÊûêÂ§±Ë¥•Êó∂ÁöÑÂ§áÁî®ÊñπÊ°àÔºâ
            function extractCommandFromText(aiResponse, originalText) {
                const response = aiResponse.toLowerCase();
                const original = originalText.toLowerCase();
                
                let action = '';
                let target = '';
                let gpioCommand = '';
                
                // ËØÜÂà´Âä®‰Ωú
                if (response.includes('ÊâìÂºÄ') || response.includes('ÂºÄÂêØ') || original.includes('ÂºÄ')) {
                    action = 'ÊâìÂºÄ';
                } else if (response.includes('ÂÖ≥Èó≠') || response.includes('ÂÖ≥') || original.includes('ÂÖ≥')) {
                    action = 'ÂÖ≥Èó≠';
                }
                
                // ËØÜÂà´ËÆæÂ§á
                if (response.includes('ÁÅØ') || original.includes('ÁÅØ')) {
                    target = 'ÁÅØ';
                    gpioCommand = action === 'ÊâìÂºÄ' ? 'gpio 17 high' : 'gpio 17 low';
                } else if (response.includes('Á©∫Ë∞É') || original.includes('Á©∫Ë∞É')) {
                    target = 'Á©∫Ë∞É';
                    gpioCommand = action === 'ÊâìÂºÄ' ? 'gpio 18 high' : 'gpio 18 low';
                } else if (response.includes('ÁîµËßÜ') || original.includes('ÁîµËßÜ')) {
                    target = 'ÁîµËßÜ';
                    gpioCommand = action === 'ÊâìÂºÄ' ? 'gpio 19 high' : 'gpio 19 low';
                }
                
                return {
                    action: action,
                    target: target,
                    gpioCommand: gpioCommand,
                    confidence: (action && target) ? 0.8 : 0.0,
                    response: (action && target) ? `Â•ΩÁöÑÔºå${target}Â∑≤${action}` : 'Êä±Ê≠âÔºåÊàëÊ≤°ÊúâÁêÜËß£ÊÇ®ÁöÑÊåá‰ª§'
                };
            }
            
            // ‰ªÖ‰ΩøÁî®WASMËß£ÊûêÔºàÂΩìÂ§ßÊ®°ÂûãAPIÂ§±Ë¥•Êó∂ÁöÑÈôçÁ∫ßÊñπÊ°àÔºâ
            function parseCommandWithWasmOnly(text) {
                // ËøôÈáåÊòØÂéüÊù•ÁöÑWASMËß£ÊûêÈÄªËæëÔºå‰∏çÂèò
                // ... ÂéüWASMËß£Êûê‰ª£Á†Å
            }

            // Â§áÁî®Êåá‰ª§Ëß£ÊûêÔºàÁ∫ØJavaScriptÔºâ
            function parseCommandFallback(text) {
                addDebug('‰ΩøÁî®Â§áÁî®JavaScriptËß£ÊûêÂô®', 'warning');
                const cleanText = text.replace(/[„ÄÇÔºÅÔºüÔºå„ÄÅÔºõÔºö""''ÔºàÔºâ„Äê„Äë\s]/g, '').toLowerCase();
                
                let command = null;
                
                // ÂºÄÁÅØÊåá‰ª§
                if (cleanText.includes('ÂºÄÁÅØ') || 
                    (cleanText.includes('ÊâìÂºÄ') && cleanText.includes('ÁÅØ'))) {
                    command = { action: 'ÊâìÂºÄ', target: 'ÁÅØ', gpioCommand: 'gpio 17 high' };
                }
                // ÂÖ≥ÁÅØÊåá‰ª§
                else if (cleanText.includes('ÂÖ≥ÁÅØ') || 
                    (cleanText.includes('ÂÖ≥Èó≠') && cleanText.includes('ÁÅØ'))) {
                    command = { action: 'ÂÖ≥Èó≠', target: 'ÁÅØ', gpioCommand: 'gpio 17 low' };
                }
                // ÂºÄÁ©∫Ë∞ÉÊåá‰ª§
                else if (cleanText.includes('ÂºÄÁ©∫Ë∞É') || 
                    (cleanText.includes('ÊâìÂºÄ') && cleanText.includes('Á©∫Ë∞É'))) {
                    command = { action: 'ÊâìÂºÄ', target: 'Á©∫Ë∞É', gpioCommand: 'gpio 18 high' };
                }
                // ÂÖ≥Á©∫Ë∞ÉÊåá‰ª§
                else if (cleanText.includes('ÂÖ≥Á©∫Ë∞É') || 
                    (cleanText.includes('ÂÖ≥Èó≠') && cleanText.includes('Á©∫Ë∞É'))) {
                    command = { action: 'ÂÖ≥Èó≠', target: 'Á©∫Ë∞É', gpioCommand: 'gpio 18 low' };
                }
                // ÂºÄÁîµËßÜÊåá‰ª§
                else if (cleanText.includes('ÂºÄÁîµËßÜ') || 
                    (cleanText.includes('ÊâìÂºÄ') && cleanText.includes('ÁîµËßÜ'))) {
                    command = { action: 'ÊâìÂºÄ', target: 'ÁîµËßÜ', gpioCommand: 'gpio 19 high' };
                }
                // ÂÖ≥ÁîµËßÜÊåá‰ª§
                else if (cleanText.includes('ÂÖ≥ÁîµËßÜ') || 
                    (cleanText.includes('ÂÖ≥Èó≠') && cleanText.includes('ÁîµËßÜ'))) {
                    command = { action: 'ÂÖ≥Èó≠', target: 'ÁîµËßÜ', gpioCommand: 'gpio 19 low' };
                }

                if (command) {
                    commandResult.textContent = `${command.action} ${command.target}`;
                    commandContainer.style.display = 'block';
                    commandContainer.className = 'status-item result';
                    
                    // ÊòæÁ§∫GPIOÊéßÂà∂ÂëΩ‰ª§
                    gpioCommand.textContent = command.gpioCommand;
                    gpioContainer.style.display = 'block';
                    
                    executeCommand(command);
                } else {
                    commandResult.textContent = `Êó†Ê≥ïÁêÜËß£Êåá‰ª§ "${text}"ÔºåËØ∑ËØ¥ÊîØÊåÅÁöÑËÆæÂ§áÊéßÂà∂Êåá‰ª§`;
                    commandContainer.style.display = 'block';
                    commandContainer.className = 'status-item error';
                    
                    // ËØ≠Èü≥ÂõûÂ∫î
                    if (hasSpeechSynthesis) {
                        speak('Êä±Ê≠âÔºåÊàëÊ≤°ÊúâÁêÜËß£ÊÇ®ÁöÑÊåá‰ª§ÔºåËØ∑ËØ¥ÂºÄÁÅØ„ÄÅÂÖ≥ÁÅØ„ÄÅÂºÄÁ©∫Ë∞É„ÄÅÂÖ≥Á©∫Ë∞É„ÄÅÂºÄÁîµËßÜ„ÄÅÂÖ≥ÁîµËßÜÁ≠âÊåá‰ª§');
                    }
                }
            }
            
            // ÊâßË°åËÆæÂ§áÊéßÂà∂Êåá‰ª§
            function executeCommand(command) {
                const isOn = command.action === 'ÊâìÂºÄ';
                let responseText = '';

                if (command.target === 'ÁÅØ') {
                    lightStatus.textContent = isOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
                    lightStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'Â•ΩÁöÑÔºåÁÅØÂ∑≤ÊâìÂºÄ' : 'Â•ΩÁöÑÔºåÁÅØÂ∑≤ÂÖ≥Èó≠';
                }
                else if (command.target === 'Á©∫Ë∞É') {
                    acStatus.textContent = isOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
                    acStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'Â•ΩÁöÑÔºåÁ©∫Ë∞ÉÂ∑≤ÊâìÂºÄ' : 'Â•ΩÁöÑÔºåÁ©∫Ë∞ÉÂ∑≤ÂÖ≥Èó≠';
                }
                else if (command.target === 'ÁîµËßÜ') {
                    tvStatus.textContent = isOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
                    tvStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'Â•ΩÁöÑÔºåÁîµËßÜÂ∑≤ÊâìÂºÄ' : 'Â•ΩÁöÑÔºåÁîµËßÜÂ∑≤ÂÖ≥Èó≠';
                }
                
                addDebug(`ËÆæÂ§áÊéßÂà∂: ${command.target} -> ${isOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success');
                
                // ËØ≠Èü≥ÂõûÂ∫î
                if (hasSpeechSynthesis && responseText) {
                    speak(responseText);
                }
                
                // Ê®°ÊãüËÆæÂ§áÂìçÂ∫îÂª∂Ëøü
                setTimeout(() => {
                    updateConnectionStatus(true);
                    addDebug('ËÆæÂ§áÂìçÂ∫îÊàêÂäü', 'success');
                }, 500);
            }
            
            // Á≥ªÁªüÂàùÂßãÂåñ
            async function initializeSystem() {
                addDebug('Á≥ªÁªüÂàùÂßãÂåñÂºÄÂßã', 'info');
                
                // Âä†ËΩΩAPIÈÖçÁΩÆ
                loadApiConfig();
                
                // Ê∑ªÂä†APIÈÖçÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.getElementById('api-provider').addEventListener('change', updateApiProviderUI);
                document.getElementById('api-key').addEventListener('input', function() {
                    apiConfig.apiKey = this.value;
                    saveApiConfig();
                });
                document.getElementById('api-url').addEventListener('input', function() {
                    apiConfig.apiUrl = this.value;
                    saveApiConfig();
                });
                document.getElementById('api-model').addEventListener('input', function() {
                    apiConfig.model = this.value;
                    saveApiConfig();
                });
                
                // ÂàùÂßãÂåñWASMÊ®°Âùó
                const wasmSuccess = await initWasmModule();
                
                if (wasmSuccess || apiConfig.isConnected) {
                    status.textContent = '‚úÖ Á≥ªÁªüÂ∑≤Â∞±Áª™ÔºåÁÇπÂáªÊåâÈíÆÂºÄÂßãËØ≠Èü≥Âî§ÈÜíÁõëÂê¨';
                    startBtn.querySelector('.mic-text').textContent = 'ÂºÄÂßãËØ≠Èü≥Âî§ÈÜí';
                    startBtn.disabled = false;
                    
                    addDebug('Êô∫ËÉΩËØ≠Èü≥ÊéßÂà∂Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê', 'success');
                    updateConnectionStatus(false); // ÂàùÂßãÁä∂ÊÄÅ‰∏∫Á¶ªÁ∫ø

                    // ÊòæÁ§∫ÂΩìÂâçËß£ÊûêÂºïÊìéÁä∂ÊÄÅ
                    if (apiConfig.isConnected) {
                        addDebug('üß† Â§ßÊ®°ÂûãAIÂºïÊìéÂ∑≤Â∞±Áª™ÔºåÊîØÊåÅÂ§öÊ†∑ÂåñËØ≠Èü≥Êåá‰ª§', 'success');
                    } else if (wasmSuccess) {
                        addDebug('üîß WASMÂºïÊìéÂ∑≤Â∞±Áª™ÔºåÊîØÊåÅÂü∫Á°ÄËØ≠Èü≥Êåá‰ª§', 'info');
                    }

                    // Ëá™Âä®ÂºÄÂßãÂî§ÈÜíÁõëÂê¨
                    setTimeout(() => {
                        if (hasSpeechSynthesis) {
                            if (apiConfig.isConnected) {
                                speak('Â∞èÊ¨ßËØ≠Èü≥Âä©ÊâãÂ∑≤ÂêØÂä®ÔºåAIÊô∫ËÉΩÂºïÊìéÂ∞±Áª™ÔºåËØ∑ËØ¥Â∞èÊ¨ßÂ∞èÊ¨ßÊù•Âî§ÈÜíÊàëÔºåÊîØÊåÅÂ§öÊ†∑ÂåñËØ≠Èü≥Êåá‰ª§');
                            } else {
                                speak('Â∞èÊ¨ßËØ≠Èü≥Âä©ÊâãÂ∑≤ÂêØÂä®ÔºåWASMÂºïÊìéÂ∞±Áª™ÔºåËØ∑ËØ¥Â∞èÊ¨ßÂ∞èÊ¨ßÊù•Âî§ÈÜíÊàë');
                            }
                        }
                        startWakeListening();
                    }, 1000);
                } else {
                    status.textContent = '‚ùå Êú™ÈÖçÁΩÆAIÂºïÊìé‰∏îWASMÊ®°ÂùóÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈÖçÁΩÆAPIÊàñÊ£ÄÊü•WASM';
                    startBtn.querySelector('.mic-text').textContent = 'ÈúÄË¶ÅÈÖçÁΩÆ';
                    startBtn.disabled = true;
                }
            }

            // ÂºÄÂßãÁ≥ªÁªüÂàùÂßãÂåñ
            initializeSystem();
        });
        
        // ÂàáÊç¢Ë∞ÉËØïÈù¢ÊùøÊòæÁ§∫
        function toggleDebug() {
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        }
        
        // ÂÖ®Â±ÄÊµãËØïAPIËøûÊé•ÂáΩÊï∞
        window.testApiConnection = async function() {
            // ‰ªéDOMËé∑ÂèñÊúÄÊñ∞ÈÖçÁΩÆ
            const provider = document.getElementById('api-provider').value;
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const model = document.getElementById('api-model').value;
            
            if (!apiKey.trim()) {
                alert('ËØ∑ÂÖàÂ°´ÂÖ•APIÂØÜÈí•');
                return;
            }
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄÈÖçÁΩÆÂØπË±°
            window.apiConfig = window.apiConfig || {};
            window.apiConfig.provider = provider;
            window.apiConfig.apiKey = apiKey;
            window.apiConfig.apiUrl = apiUrl;
            window.apiConfig.model = model;
            
            // Â¶ÇÊûúÂú®DOMContentLoadedÂÜÖÈÉ®ÔºåË∞ÉÁî®ÂÜÖÈÉ®ÂáΩÊï∞
            if (typeof testApiConnection === 'function') {
                await testApiConnection();
            } else {
                // Âê¶ÂàôÁÆÄÂçïÊµãËØïËøûÊé•
                console.log('Testing API connection...', window.apiConfig);
                alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
            }
        };
    </script>
</body>
</html>
