<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯­éŸ³æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* å¢å¼ºçš„æ ·å¼ */
        .voice-control {
            text-align: center;
            margin: 40px 0;
        }
        
        .mic-button {
            display: inline-block;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .mic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .mic-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .mic-button.listening {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            animation: pulse 2s infinite;
        }
        
        .mic-button.wake-listening {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            animation: wakeGlow 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(56, 239, 125, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0);
            }
        }
        
        @keyframes wakeGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }
        
        .mic-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .status-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        
        .status-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .status-item.result {
            border-left-color: #38ef7d;
            background: #f0fff4;
        }
        
        .status-item.error {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .status-item.wake {
            border-left-color: #feca57;
            background: #fffbf0;
        }
        
        .status-item.wasm {
            border-left-color: #9b59b6;
            background: #f8f4ff;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .device-card:hover {
            transform: translateY(-5px);
        }
        
        .device-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .device-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .device-status {
            font-size: 14px;
            color: #666;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .status-on {
            background: #d4edda;
            color: #155724;
        }
        
        .status-off {
            background: #f8d7da;
            color: #721c24;
        }
        
        .debug-panel {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-panel h3 {
            color: #fff;
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .connection-online {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .footer {
            text-align: center;
            padding: 30px 0;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 50px;
        }
        
        .toggle-debug {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .toggle-debug:hover {
            background: #5a6268;
        }

        .wake-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            z-index: 2000;
            display: none;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ™ï¸ æ™ºèƒ½è¯­éŸ³æ§åˆ¶ç³»ç»Ÿ</h1>
            <p>è¯´"å°æ¬§å°æ¬§"å”¤é†’ç³»ç»Ÿï¼Œæ”¯æŒç¯å…‰ã€ç©ºè°ƒã€ç”µè§†ç­‰è®¾å¤‡æ§åˆ¶</p>
        </header>
        
        <main>
            <div class="voice-control">
                <button id="start-recognition" class="mic-button">
                    <span class="mic-icon">ğŸ¤</span>
                    <span class="mic-text">æ­£åœ¨åˆå§‹åŒ–...</span>
                </button>
            </div>
            
            <div class="status-panel">
                <div class="status-item">
                    <strong>ç³»ç»ŸçŠ¶æ€ï¼š</strong>
                    <span id="listening-status">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</span>
                </div>
                
                <div class="status-item wasm" id="wasm-container" style="display:none;">
                    <strong>ğŸ§  WASMå¼•æ“ï¼š</strong>
                    <div id="wasm-status"></div>
                </div>
                
                <div class="status-item wake" id="wake-container" style="display:none;">
                    <strong>ğŸ”Š å”¤é†’çŠ¶æ€ï¼š</strong>
                    <div id="wake-status"></div>
                </div>
                
                <div class="status-item" id="transcription-container" style="display:none;">
                    <strong>ğŸ¯ è¯†åˆ«ç»“æœï¼š</strong>
                    <div id="transcription"></div>
                </div>
                
                <div class="status-item result" id="command-container" style="display:none;">
                    <strong>âš¡ æŒ‡ä»¤è§£æï¼š</strong>
                    <div id="command-result"></div>
                </div>

                <div class="status-item wasm" id="gpio-container" style="display:none;">
                    <strong>ğŸ”Œ GPIOæ§åˆ¶ï¼š</strong>
                    <div id="gpio-command"></div>
                </div>

                <div class="status-item result" id="response-container" style="display:none;">
                    <strong>ğŸ—£ï¸ ç³»ç»Ÿå›åº”ï¼š</strong>
                    <div id="voice-response"></div>
                </div>
            </div>
            
            <div class="device-controls">
                <h2>ğŸ  è®¾å¤‡çŠ¶æ€</h2>
                <div class="device-grid">
                    <div class="device-card">
                        <div class="device-icon">ğŸ’¡</div>
                        <div class="device-name">å®¢å…ä¸»ç¯</div>
                        <div class="device-status">
                            çŠ¶æ€: <span id="light-status" class="status-indicator status-off">å…³é—­</span><br>
                            GPIO: <span class="status-indicator status-off">17</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">â„ï¸</div>
                        <div class="device-name">ç©ºè°ƒç³»ç»Ÿ</div>
                        <div class="device-status">
                            çŠ¶æ€: <span id="ac-status" class="status-indicator status-off">å…³é—­</span><br>
                            GPIO: <span class="status-indicator status-off">18</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">ğŸ“º</div>
                        <div class="device-name">æ™ºèƒ½ç”µè§†</div>
                        <div class="device-status">
                            çŠ¶æ€: <span id="tv-status" class="status-indicator status-off">å…³é—­</span><br>
                            GPIO: <span class="status-indicator status-off">19</span>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <div class="device-icon">ğŸŒ¡ï¸</div>
                        <div class="device-name">æ¸©åº¦ä¼ æ„Ÿå™¨</div>
                        <div class="device-status">
                            æ¸©åº¦: <span class="status-indicator status-on">22Â°C</span><br>
                            GPIO: <span class="status-indicator status-on">åªè¯»</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼šå…ˆè¯´"å°æ¬§å°æ¬§"å”¤é†’ï¼Œç„¶åè¯´"å¼€ç¯"ã€"å…³ç¯"ã€"å¼€ç©ºè°ƒ"ã€"å…³ç©ºè°ƒ"ã€"å¼€ç”µè§†"ã€"å…³ç”µè§†"ç­‰æŒ‡ä»¤</p>
                <button class="toggle-debug" onclick="toggleDebug()">æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯</button>
            </div>
            
            <div class="debug-panel" id="debug-panel" style="display:none;">
                <h3>ğŸ”§ ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯</h3>
                <div id="debug-info">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
            </div>
        </main>
    </div>
    
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="connection-status" class="connection-status connection-offline">
        è®¾å¤‡ç¦»çº¿
    </div>

    <!-- å”¤é†’æç¤º -->
    <div id="wake-indicator" class="wake-indicator">
        ğŸ¯ å°æ¬§å·²å”¤é†’ï¼Œè¯·è¯´å‡ºæŒ‡ä»¤
    </div>

    <!-- å¼•å…¥WASMæ¨¡å— -->
    <script src="nlp-parser.js"></script>

    <script>
        console.log('ğŸš€ æ™ºèƒ½è¯­éŸ³æ§åˆ¶ç³»ç»Ÿå¯åŠ¨ä¸­...');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOMåŠ è½½å®Œæˆ');
            
            // è·å–DOMå…ƒç´ 
            const startBtn = document.getElementById('start-recognition');
            const status = document.getElementById('listening-status');
            const wasmContainer = document.getElementById('wasm-container');
            const wasmStatus = document.getElementById('wasm-status');
            const wakeContainer = document.getElementById('wake-container');
            const wakeStatus = document.getElementById('wake-status');
            const transcription = document.getElementById('transcription');
            const transcriptionContainer = document.getElementById('transcription-container');
            const commandResult = document.getElementById('command-result');
            const commandContainer = document.getElementById('command-container');
            const gpioContainer = document.getElementById('gpio-container');
            const gpioCommand = document.getElementById('gpio-command');
            const responseContainer = document.getElementById('response-container');
            const voiceResponse = document.getElementById('voice-response');
            const lightStatus = document.getElementById('light-status');
            const acStatus = document.getElementById('ac-status');
            const tvStatus = document.getElementById('tv-status');
            const debugInfo = document.getElementById('debug-info');
            const connectionStatus = document.getElementById('connection-status');
            const wakeIndicator = document.getElementById('wake-indicator');
            
            // è¯­éŸ³åˆæˆå¯¹è±¡
            let speechSynthesis = window.speechSynthesis;
            let currentVoice = null;

            // WASMæ¨¡å—
            let nlpModule = null;
            let isWasmReady = false;

            // ç³»ç»ŸçŠ¶æ€
            let isWakeListening = false;  // æ˜¯å¦åœ¨ç­‰å¾…å”¤é†’è¯
            let isCommandListening = false;  // æ˜¯å¦åœ¨ç­‰å¾…æŒ‡ä»¤
            let wakeRecognition = null;
            let commandRecognition = null;
            
            // åˆå§‹åŒ–WASMæ¨¡å—
            async function initWasmModule() {
                try {
                    addDebug('å¼€å§‹åŠ è½½WASMæ¨¡å—...', 'info');
                    wasmContainer.style.display = 'block';
                    wasmStatus.textContent = 'æ­£åœ¨åŠ è½½WASMæ¨¡å—...';
                    
                    // åŠ è½½WASMæ¨¡å—
                    nlpModule = await createNlpParserModule();
                    isWasmReady = true;
                    
                    addDebug('WASMæ¨¡å—åŠ è½½æˆåŠŸ', 'success');
                    wasmStatus.textContent = 'âœ… WASM NLPå¼•æ“å·²å°±ç»ª';
                    
                    return true;
                } catch (error) {
                    addDebug(`WASMæ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    wasmStatus.textContent = `âŒ WASMåŠ è½½å¤±è´¥: ${error.message}`;
                    isWasmReady = false;
                    return false;
                }
            }
            
            // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
            function initSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½
                    speechSynthesis.onvoiceschanged = function() {
                        const voices = speechSynthesis.getVoices();
                        // ä¼˜å…ˆé€‰æ‹©ä¸­æ–‡è¯­éŸ³
                        currentVoice = voices.find(voice => 
                            voice.lang.includes('zh') || voice.lang.includes('cmn')
                        ) || voices[0];
                        
                        if (currentVoice) {
                            addDebug(`è¯­éŸ³åˆæˆåˆå§‹åŒ–æˆåŠŸï¼Œä½¿ç”¨è¯­éŸ³: ${currentVoice.name}`, 'success');
                        }
                    };
                    
                    // è§¦å‘è¯­éŸ³åˆ—è¡¨åŠ è½½
                    speechSynthesis.getVoices();
                    addDebug('è¯­éŸ³åˆæˆåŠŸèƒ½å¯ç”¨', 'success');
                    return true;
                } else {
                    addDebug('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ', 'warning');
                    return false;
                }
            }

            // è¯­éŸ³å›åº”å‡½æ•°
            function speak(text) {
                if (!speechSynthesis || !currentVoice) {
                    addDebug('è¯­éŸ³åˆæˆä¸å¯ç”¨', 'warning');
                    return;
                }

                // åœæ­¢å½“å‰æ’­æ”¾
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = currentVoice;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                utterance.onstart = function() {
                    addDebug(`å¼€å§‹è¯­éŸ³å›åº”: "${text}"`, 'voice');
                    voiceResponse.textContent = text;
                    responseContainer.style.display = 'block';
                };

                utterance.onend = function() {
                    addDebug('è¯­éŸ³å›åº”å®Œæˆ', 'voice');
                };

                utterance.onerror = function(event) {
                    addDebug(`è¯­éŸ³å›åº”é”™è¯¯: ${event.error}`, 'error');
                };

                speechSynthesis.speak(utterance);
            }
            
            // è°ƒè¯•ä¿¡æ¯å‡½æ•°
            function addDebug(message, type = 'info') {
                console.log(message);
                const now = new Date().toLocaleTimeString();
                const icons = {
                    info: 'â„¹ï¸',
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    voice: 'ğŸ¤',
                    wake: 'ğŸ”Š',
                    wasm: 'ğŸ§ '
                };
                const icon = icons[type] || 'â„¹ï¸';
                debugInfo.innerHTML = `<div>[${now}] ${icon} ${message}</div>` + debugInfo.innerHTML;
                
                // é™åˆ¶è°ƒè¯•ä¿¡æ¯æ¡æ•°
                const lines = debugInfo.getElementsByTagName('div');
                if (lines.length > 50) {
                    debugInfo.removeChild(lines[lines.length - 1]);
                }
            }
            
            // æ›´æ–°è¿æ¥çŠ¶æ€
            function updateConnectionStatus(connected) {
                if (connected) {
                    connectionStatus.textContent = 'è®¾å¤‡åœ¨çº¿';
                    connectionStatus.className = 'connection-status connection-online';
                } else {
                    connectionStatus.textContent = 'è®¾å¤‡ç¦»çº¿';
                    connectionStatus.className = 'connection-status connection-offline';
                }
            }
            
            // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
            addDebug('æ£€æŸ¥æµè§ˆå™¨è¯­éŸ³è¯†åˆ«æ”¯æŒ...', 'info');
            const hasWebkitSpeech = 'webkitSpeechRecognition' in window;
            const hasSpeech = 'SpeechRecognition' in window;
            
            addDebug(`webkitSpeechRecognition: ${hasWebkitSpeech}`, 'info');
            addDebug(`SpeechRecognition: ${hasSpeech}`, 'info');
            
            if (!hasWebkitSpeech && !hasSpeech) {
                status.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨';
                startBtn.disabled = true;
                addDebug('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«API', 'error');
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼\n\nè¯·ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š\nâ€¢ Google Chrome\nâ€¢ Microsoft Edge\nâ€¢ å…¶ä»–åŸºäºChromiumçš„æµè§ˆå™¨');
                return;
            }

            // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
            const hasSpeechSynthesis = initSpeechSynthesis();
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            // åˆ›å»ºå”¤é†’è¯è¯†åˆ«å™¨
            try {
                wakeRecognition = new SpeechRecognition();
                wakeRecognition.continuous = true;  // æŒç»­ç›‘å¬
                wakeRecognition.interimResults = true;
                wakeRecognition.lang = 'zh-CN';
                wakeRecognition.maxAlternatives = 1;
                
                // åˆ›å»ºæŒ‡ä»¤è¯†åˆ«å™¨
                commandRecognition = new SpeechRecognition();
                commandRecognition.continuous = false;
                commandRecognition.interimResults = true;
                commandRecognition.lang = 'zh-CN';
                commandRecognition.maxAlternatives = 1;
                
                addDebug('è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                addDebug(`è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                status.textContent = 'âŒ è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–å¤±è´¥';
                startBtn.disabled = true;
                return;
            }
            
            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startBtn.addEventListener('click', function() {
                if (isWakeListening) {
                    // åœæ­¢å”¤é†’ç›‘å¬
                    stopWakeListening();
                } else if (isCommandListening) {
                    // åœæ­¢æŒ‡ä»¤ç›‘å¬
                    stopCommandListening();
                } else {
                    // å¼€å§‹å”¤é†’ç›‘å¬
                    startWakeListening();
                }
            });

            // å¼€å§‹å”¤é†’ç›‘å¬
            function startWakeListening() {
                if (!isWasmReady) {
                    addDebug('WASMæ¨¡å—æœªå°±ç»ªï¼Œæ— æ³•å¯åŠ¨å”¤é†’ç›‘å¬', 'error');
                    status.textContent = 'âŒ ç­‰å¾…WASMæ¨¡å—åŠ è½½...';
                    return;
                }

                try {
                    addDebug('å¼€å§‹ç›‘å¬å”¤é†’è¯ "å°æ¬§å°æ¬§"', 'wake');
                    isWakeListening = true;
                    
                    startBtn.classList.add('wake-listening');
                    startBtn.querySelector('.mic-text').textContent = 'æ­£åœ¨ç›‘å¬å”¤é†’è¯... (ç‚¹å‡»åœæ­¢)';
                    status.textContent = 'ğŸ”Š æ­£åœ¨ç›‘å¬ "å°æ¬§å°æ¬§"ï¼Œè¯·æ¸…æ™°è¯´å‡ºå”¤é†’è¯...';
                    
                    wakeContainer.style.display = 'block';
                    wakeStatus.textContent = 'ç­‰å¾…å”¤é†’è¯ "å°æ¬§å°æ¬§"...';
                    
                    wakeRecognition.start();
                } catch (error) {
                    addDebug(`å¯åŠ¨å”¤é†’ç›‘å¬å¤±è´¥: ${error.message}`, 'error');
                    status.textContent = 'âŒ å¯åŠ¨å¤±è´¥: ' + error.message;
                    isWakeListening = false;
                }
            }

            // åœæ­¢å”¤é†’ç›‘å¬
            function stopWakeListening() {
                addDebug('åœæ­¢å”¤é†’ç›‘å¬', 'wake');
                isWakeListening = false;
                wakeRecognition.stop();
                
                startBtn.classList.remove('wake-listening');
                startBtn.querySelector('.mic-text').textContent = 'å¼€å§‹è¯­éŸ³å”¤é†’';
                status.textContent = 'â¸ï¸ å·²åœæ­¢ç›‘å¬ï¼Œç‚¹å‡»æŒ‰é’®é‡æ–°å¼€å§‹';
                wakeContainer.style.display = 'none';
            }

            // å¼€å§‹æŒ‡ä»¤ç›‘å¬
            function startCommandListening() {
                try {
                    addDebug('å¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤', 'voice');
                    isCommandListening = true;
                    
                    startBtn.classList.add('listening');
                    startBtn.querySelector('.mic-text').textContent = 'æ­£åœ¨ç›‘å¬æŒ‡ä»¤... (ç‚¹å‡»åœæ­¢)';
                    status.textContent = 'ğŸ™ï¸ è¯·è¯´å‡ºæ‚¨çš„æŒ‡ä»¤...';

                    // æ˜¾ç¤ºå”¤é†’æç¤º
                    wakeIndicator.style.display = 'block';
                    setTimeout(() => {
                        wakeIndicator.style.display = 'none';
                    }, 2000);
                    
                    commandRecognition.start();
                } catch (error) {
                    addDebug(`å¯åŠ¨æŒ‡ä»¤ç›‘å¬å¤±è´¥: ${error.message}`, 'error');
                    isCommandListening = false;
                }
            }

            // åœæ­¢æŒ‡ä»¤ç›‘å¬
            function stopCommandListening() {
                addDebug('åœæ­¢æŒ‡ä»¤ç›‘å¬', 'voice');
                isCommandListening = false;
                commandRecognition.stop();
                
                startBtn.classList.remove('listening');
                
                // å›åˆ°å”¤é†’ç›‘å¬æ¨¡å¼
                setTimeout(() => {
                    if (!isWakeListening && !isCommandListening) {
                        startWakeListening();
                    }
                }, 1000);
            }
            
            // å”¤é†’è¯è¯†åˆ«äº‹ä»¶
            wakeRecognition.onresult = function(event) {
                let transcript = '';
                
                // è·å–æœ€æ–°çš„è¯†åˆ«ç»“æœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                
                if (transcript) {
                    const cleanText = transcript.replace(/[ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘\s]/g, '').toLowerCase();
                    addDebug(`å”¤é†’ç›‘å¬ç»“æœ: "${transcript}" -> "${cleanText}"`, 'wake');
                    
                    wakeStatus.textContent = `ç›‘å¬åˆ°: "${transcript}"`;
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å”¤é†’è¯
                    if (cleanText.includes('å°æ¬§å°æ¬§') || cleanText.includes('å°æ¬§') || 
                        cleanText.includes('xiaoou') || cleanText.includes('å°o')) {
                        
                        addDebug('æ£€æµ‹åˆ°å”¤é†’è¯ï¼åˆ‡æ¢åˆ°æŒ‡ä»¤æ¨¡å¼', 'wake');
                        wakeStatus.textContent = 'âœ… å”¤é†’æˆåŠŸï¼æ­£åœ¨åˆ‡æ¢åˆ°æŒ‡ä»¤æ¨¡å¼...';
                        
                        // è¯­éŸ³å›åº”
                        if (hasSpeechSynthesis) {
                            speak('æˆ‘åœ¨ï¼Œè¯·è¯´å‡ºæ‚¨çš„æŒ‡ä»¤');
                        }
                        
                        // åœæ­¢å”¤é†’ç›‘å¬ï¼Œå¼€å§‹æŒ‡ä»¤ç›‘å¬
                        stopWakeListening();
                        setTimeout(() => {
                            startCommandListening();
                        }, 500);
                    }
                }
            };

            wakeRecognition.onerror = function(event) {
                addDebug(`å”¤é†’ç›‘å¬é”™è¯¯: ${event.error}`, 'error');
                if (event.error !== 'no-speech') {
                    wakeStatus.textContent = `é”™è¯¯: ${event.error}`;
                }
            };

            wakeRecognition.onend = function() {
                if (isWakeListening) {
                    // å¦‚æœè¿˜åœ¨å”¤é†’æ¨¡å¼ï¼Œé‡æ–°å¯åŠ¨ç›‘å¬
                    setTimeout(() => {
                        if (isWakeListening) {
                            try {
                                wakeRecognition.start();
                            } catch (error) {
                                addDebug(`é‡å¯å”¤é†’ç›‘å¬å¤±è´¥: ${error.message}`, 'error');
                            }
                        }
                    }, 100);
                }
            };
            
            // æŒ‡ä»¤è¯†åˆ«äº‹ä»¶
            commandRecognition.onresult = function(event) {
                addDebug(`æ”¶åˆ°æŒ‡ä»¤è¯†åˆ«ç»“æœï¼Œå…±${event.results.length}æ¡`, 'voice');
                
                let transcript = '';
                let isFinal = false;
                
                // è·å–è¯†åˆ«ç»“æœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        transcript = result[0].transcript.trim();
                        isFinal = true;
                        break;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æœ€ç»ˆç»“æœï¼Œè·å–ä¸´æ—¶ç»“æœ
                if (!transcript && event.results.length > 0) {
                    transcript = event.results[event.results.length - 1][0].transcript.trim();
                }
                
                if (transcript) {
                    addDebug(`è¯†åˆ«æ–‡æœ¬: "${transcript}" (${isFinal ? 'æœ€ç»ˆç»“æœ' : 'ä¸´æ—¶ç»“æœ'})`, 'voice');
                    
                    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                    transcription.textContent = `"${transcript}"${isFinal ? '' : ' (è¯†åˆ«ä¸­...)'}`;
                    transcriptionContainer.style.display = 'block';
                    
                    // åªå¤„ç†æœ€ç»ˆç»“æœ
                    if (isFinal) {
                        parseCommandWithWasm(transcript);

                        // æŒ‡ä»¤å¤„ç†å®Œæˆï¼Œåœæ­¢ç›‘å¬
                        setTimeout(() => {
                            stopCommandListening();
                        }, 1000);
                    }
                }
            };
            
            commandRecognition.onerror = function(event) {
                addDebug(`æŒ‡ä»¤è¯†åˆ«é”™è¯¯: ${event.error}`, 'error');
                
                let errorMessage = 'æŒ‡ä»¤è¯†åˆ«å¤±è´¥';
                switch (event.error) {
                    case 'not-allowed':
                        errorMessage = 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸éº¦å…‹é£è®¿é—®';
                        alert('è¯·å…è®¸éº¦å…‹é£æƒé™ï¼\n\nåœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»ğŸ”’å›¾æ ‡ï¼Œç„¶åå…è®¸éº¦å…‹é£è®¿é—®ã€‚');
                        break;
                    case 'no-speech':
                        errorMessage = 'âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                        if (hasSpeechSynthesis) {
                            speak('æ²¡æœ‰å¬åˆ°æ‚¨çš„æŒ‡ä»¤ï¼Œè¯·é‡æ–°è¯´å‡º');
                        }
                        break;
                    case 'audio-capture':
                        errorMessage = 'âŒ éº¦å…‹é£è®¾å¤‡æ— æ³•ä½¿ç”¨';
                        break;
                    case 'network':
                        errorMessage = 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥';
                        break;
                }
                
                status.textContent = errorMessage;
            };
            
            commandRecognition.onend = function() {
                addDebug('æŒ‡ä»¤è¯†åˆ«ä¼šè¯ç»“æŸ', 'info');
                isCommandListening = false;
                startBtn.classList.remove('listening');
                startBtn.querySelector('.mic-text').textContent = 'å¼€å§‹è¯­éŸ³å”¤é†’';
                status.textContent = 'â¸ï¸ æŒ‡ä»¤è¯†åˆ«å®Œæˆ';
            };
            
            // ä½¿ç”¨WASMæ¨¡å—è§£æè¯­éŸ³æŒ‡ä»¤
            function parseCommandWithWasm(text) {
                if (!isWasmReady || !nlpModule) {
                    addDebug('WASMæ¨¡å—ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨è§£æ', 'warning');
                    parseCommandFallback(text);
                    return;
                }

                try {
                    // æ¸…ç†è¾“å…¥æ–‡æœ¬ï¼Œç§»é™¤æ ‡ç‚¹ç¬¦å·å’Œå¤šä½™ç©ºæ ¼
                    const cleanText = text.replace(/[ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘]/g, '').trim();
                    addDebug(`ä½¿ç”¨WASMè§£ææŒ‡ä»¤: åŸæ–‡="${text}" æ¸…ç†å="${cleanText}"`, 'wasm');
                    
                    // æ£€æŸ¥WASMæ¨¡å—å‡½æ•°æ˜¯å¦å­˜åœ¨
                    if (!nlpModule._parseCommandAndReturnJSON) {
                        throw new Error('WASMå‡½æ•°_parseCommandAndReturnJSONä¸å­˜åœ¨');
                    }
                    
                    // è°ƒç”¨WASMå‡½æ•°è§£ææŒ‡ä»¤ï¼ˆä½¿ç”¨æ¸…ç†åçš„æ–‡æœ¬ï¼‰
                    const jsonPtr = nlpModule.ccall('parseCommandAndReturnJSON', 'number', ['string'], [cleanText]);
                    
                    if (!jsonPtr || jsonPtr === 0) {
                        throw new Error('WASMå‡½æ•°è¿”å›ç©ºæŒ‡é’ˆæˆ–0');
                    }
                    
                    // è·å–JSONå­—ç¬¦ä¸²
                    const jsonString = nlpModule.UTF8ToString(jsonPtr);
                    addDebug(`WASMè§£æç»“æœ: ${jsonString}`, 'wasm');
                    
                    // é‡Šæ”¾å†…å­˜
                    if (nlpModule._freeJSONResult) {
                        nlpModule._freeJSONResult(jsonPtr);
                    } else {
                        addDebug('è­¦å‘Šï¼šfreeJSONResultå‡½æ•°ä¸å­˜åœ¨ï¼Œå¯èƒ½æœ‰å†…å­˜æ³„æ¼', 'warning');
                    }
                    
                    // è§£æJSONç»“æœ
                    const command = JSON.parse(jsonString);
                    
                    // æ£€æŸ¥è§£æç»“æœçš„æœ‰æ•ˆæ€§
                    addDebug(`è§£æåˆ°çš„æŒ‡ä»¤å¯¹è±¡: ${JSON.stringify(command)}`, 'wasm');
                    
                    if (command && command.action && command.target && 
                        command.action.trim() !== '' && command.target.trim() !== '') {
                        addDebug(`æŒ‡ä»¤è§£ææˆåŠŸ: ${JSON.stringify(command)}`, 'success');
                        commandResult.textContent = `${command.action} ${command.target}`;
                        commandContainer.style.display = 'block';
                        commandContainer.className = 'status-item result';
                        
                        // æ˜¾ç¤ºGPIOæ§åˆ¶å‘½ä»¤
                        if (command.gpioCommand && command.gpioCommand.trim() !== '') {
                            gpioCommand.textContent = command.gpioCommand;
                            gpioContainer.style.display = 'block';
                            addDebug(`GPIOæ§åˆ¶å‘½ä»¤: ${command.gpioCommand}`, 'wasm');
                        }
                        
                        // æ‰§è¡Œè®¾å¤‡æ§åˆ¶
                        executeCommand(command);
                    } else {
                        addDebug(`WASMè¿”å›äº†æ— æ•ˆçš„æŒ‡ä»¤å¯¹è±¡: ${JSON.stringify(command)}`, 'warning');
                        // å¦‚æœWASMè§£æå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨è§£æ
                        addDebug('WASMè§£æå¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨è§£æå™¨', 'warning');
                        parseCommandFallback(text);
                    }
                } catch (error) {
                    addDebug(`WASMè§£æå¤±è´¥: ${error.message}`, 'error');
                    addDebug(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                    // å¦‚æœWASMè§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨è§£æå™¨
                    addDebug('ç”±äºWASMé”™è¯¯ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨è§£æå™¨', 'warning');
                    parseCommandFallback(text);
                }
            }

            // å¤‡ç”¨æŒ‡ä»¤è§£æï¼ˆçº¯JavaScriptï¼‰
            function parseCommandFallback(text) {
                addDebug('ä½¿ç”¨å¤‡ç”¨JavaScriptè§£æå™¨', 'warning');
                const cleanText = text.replace(/[ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘\s]/g, '').toLowerCase();
                
                let command = null;
                
                // å¼€ç¯æŒ‡ä»¤
                if (cleanText.includes('å¼€ç¯') || 
                    (cleanText.includes('æ‰“å¼€') && cleanText.includes('ç¯'))) {
                    command = { action: 'æ‰“å¼€', target: 'ç¯', gpioCommand: 'gpio 17 high' };
                }
                // å…³ç¯æŒ‡ä»¤
                else if (cleanText.includes('å…³ç¯') || 
                    (cleanText.includes('å…³é—­') && cleanText.includes('ç¯'))) {
                    command = { action: 'å…³é—­', target: 'ç¯', gpioCommand: 'gpio 17 low' };
                }
                // å¼€ç©ºè°ƒæŒ‡ä»¤
                else if (cleanText.includes('å¼€ç©ºè°ƒ') || 
                    (cleanText.includes('æ‰“å¼€') && cleanText.includes('ç©ºè°ƒ'))) {
                    command = { action: 'æ‰“å¼€', target: 'ç©ºè°ƒ', gpioCommand: 'gpio 18 high' };
                }
                // å…³ç©ºè°ƒæŒ‡ä»¤
                else if (cleanText.includes('å…³ç©ºè°ƒ') || 
                    (cleanText.includes('å…³é—­') && cleanText.includes('ç©ºè°ƒ'))) {
                    command = { action: 'å…³é—­', target: 'ç©ºè°ƒ', gpioCommand: 'gpio 18 low' };
                }
                // å¼€ç”µè§†æŒ‡ä»¤
                else if (cleanText.includes('å¼€ç”µè§†') || 
                    (cleanText.includes('æ‰“å¼€') && cleanText.includes('ç”µè§†'))) {
                    command = { action: 'æ‰“å¼€', target: 'ç”µè§†', gpioCommand: 'gpio 19 high' };
                }
                // å…³ç”µè§†æŒ‡ä»¤
                else if (cleanText.includes('å…³ç”µè§†') || 
                    (cleanText.includes('å…³é—­') && cleanText.includes('ç”µè§†'))) {
                    command = { action: 'å…³é—­', target: 'ç”µè§†', gpioCommand: 'gpio 19 low' };
                }

                if (command) {
                    commandResult.textContent = `${command.action} ${command.target}`;
                    commandContainer.style.display = 'block';
                    commandContainer.className = 'status-item result';
                    
                    // æ˜¾ç¤ºGPIOæ§åˆ¶å‘½ä»¤
                    gpioCommand.textContent = command.gpioCommand;
                    gpioContainer.style.display = 'block';
                    
                    executeCommand(command);
                } else {
                    commandResult.textContent = `æ— æ³•ç†è§£æŒ‡ä»¤ "${text}"ï¼Œè¯·è¯´æ”¯æŒçš„è®¾å¤‡æ§åˆ¶æŒ‡ä»¤`;
                    commandContainer.style.display = 'block';
                    commandContainer.className = 'status-item error';
                    
                    // è¯­éŸ³å›åº”
                    if (hasSpeechSynthesis) {
                        speak('æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„æŒ‡ä»¤ï¼Œè¯·è¯´å¼€ç¯ã€å…³ç¯ã€å¼€ç©ºè°ƒã€å…³ç©ºè°ƒã€å¼€ç”µè§†ã€å…³ç”µè§†ç­‰æŒ‡ä»¤');
                    }
                }
            }
            
            // æ‰§è¡Œè®¾å¤‡æ§åˆ¶æŒ‡ä»¤
            function executeCommand(command) {
                const isOn = command.action === 'æ‰“å¼€';
                let responseText = '';

                if (command.target === 'ç¯') {
                    lightStatus.textContent = isOn ? 'å¼€å¯' : 'å…³é—­';
                    lightStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'å¥½çš„ï¼Œç¯å·²æ‰“å¼€' : 'å¥½çš„ï¼Œç¯å·²å…³é—­';
                }
                else if (command.target === 'ç©ºè°ƒ') {
                    acStatus.textContent = isOn ? 'å¼€å¯' : 'å…³é—­';
                    acStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'å¥½çš„ï¼Œç©ºè°ƒå·²æ‰“å¼€' : 'å¥½çš„ï¼Œç©ºè°ƒå·²å…³é—­';
                }
                else if (command.target === 'ç”µè§†') {
                    tvStatus.textContent = isOn ? 'å¼€å¯' : 'å…³é—­';
                    tvStatus.className = `status-indicator ${isOn ? 'status-on' : 'status-off'}`;
                    responseText = isOn ? 'å¥½çš„ï¼Œç”µè§†å·²æ‰“å¼€' : 'å¥½çš„ï¼Œç”µè§†å·²å…³é—­';
                }
                
                addDebug(`è®¾å¤‡æ§åˆ¶: ${command.target} -> ${isOn ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                
                // è¯­éŸ³å›åº”
                if (hasSpeechSynthesis && responseText) {
                    speak(responseText);
                }
                
                // æ¨¡æ‹Ÿè®¾å¤‡å“åº”å»¶è¿Ÿ
                setTimeout(() => {
                    updateConnectionStatus(true);
                    addDebug('è®¾å¤‡å“åº”æˆåŠŸ', 'success');
                }, 500);
            }
            
            // ç³»ç»Ÿåˆå§‹åŒ–
            async function initializeSystem() {
                addDebug('ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹', 'info');
                
                // åˆå§‹åŒ–WASMæ¨¡å—
                const wasmSuccess = await initWasmModule();
                
                if (wasmSuccess) {
                    status.textContent = 'âœ… ç³»ç»Ÿå·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹è¯­éŸ³å”¤é†’ç›‘å¬';
                    startBtn.querySelector('.mic-text').textContent = 'å¼€å§‹è¯­éŸ³å”¤é†’';
                    startBtn.disabled = false;
                    
                    addDebug('æ™ºèƒ½è¯­éŸ³æ§åˆ¶ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
                    updateConnectionStatus(false); // åˆå§‹çŠ¶æ€ä¸ºç¦»çº¿

                    // è‡ªåŠ¨å¼€å§‹å”¤é†’ç›‘å¬
                    setTimeout(() => {
                        if (hasSpeechSynthesis) {
                            speak('å°æ¬§è¯­éŸ³åŠ©æ‰‹å·²å¯åŠ¨ï¼ŒWASMå¼•æ“å°±ç»ªï¼Œè¯·è¯´å°æ¬§å°æ¬§æ¥å”¤é†’æˆ‘');
                        }
                        startWakeListening();
                    }, 1000);
                } else {
                    status.textContent = 'âŒ WASMæ¨¡å—åŠ è½½å¤±è´¥ï¼Œç³»ç»ŸåŠŸèƒ½å—é™';
                    startBtn.querySelector('.mic-text').textContent = 'ç³»ç»Ÿé”™è¯¯';
                    startBtn.disabled = true;
                }
            }

            // å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–
            initializeSystem();
        });
        
        // åˆ‡æ¢è°ƒè¯•é¢æ¿æ˜¾ç¤º
        function toggleDebug() {
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
            } else {
                debugPanel.style.display = 'none';
            }
        }
    </script>
</body>
</html>